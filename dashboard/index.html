<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEAGUEbuddy Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .trade-team-col {
            background: #23242a;
            border-radius: 16px;
            padding: 24px;
            min-width: 260px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.10);
        }

        .trade-assets {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .trade-card {
            background: #2e2f36;
            border-radius: 12px;
            padding: 16px 18px;
            color: #fff;
            font-weight: 600;
            min-width: 120px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10);
            cursor: pointer;
            border: 2px solid transparent;
            transition: border 0.2s, background 0.2s;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .trade-card.selected {
            border: 2px solid #ffd600;
            background: #181818;
            color: #ffd600;
        }

        .trade-card .trade-block {
            background: #ffd600;
            color: #23242a;
            font-size: 0.85rem;
            font-weight: 700;
            border-radius: 6px;
            padding: 2px 8px;
            margin-top: 6px;
        }

        .trade-card .trade-pos {
            font-size: 0.95rem;
            color: #ffd600;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .trade-card .trade-team {
            font-size: 0.85rem;
            color: #bbb;
            margin-bottom: 2px;
        }

        .trade-card .trade-age {
            font-size: 0.85rem;
            color: #bbb;
            margin-top: 2px;
        }

        .trade-card .trade-salary {
            font-size: 0.9rem;
            color: #ffd600;
            margin-top: 2px;
        }

        #user-profile-bar {
            position: fixed;
            top: 0;
            right: 0;
            width: 320px;
            height: 64px;
            background: #181818;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            z-index: 1000;
            padding: 0 32px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10);
            font-size: 1.1rem;
        }

        #user-profile-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        #user-profile-content img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #ffd600;
            object-fit: cover;
        }

        #user-profile-content div {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        #user-profile-content div div {
            font-weight: 700;
        }

        #user-profile-content div div:last-child {
            font-size: 0.95rem;
            color: #ffd600;
        }

        #user-profile-content a {
            margin-left: 24px;
            color: #ffd600;
            font-weight: 700;
            text-decoration: none;
        }
    </style>
</head>

<body>
    <div id="user-profile-bar">
        <div id="user-profile-content"></div>
    </div>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <img src="logo-new.png" alt="LEAGUEbuddy Logo">
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li class="sidebar-link active" data-section="home">Home</li>
                    <li class="sidebar-link" data-section="league-info">League Info</li>
                    <li class="sidebar-link" data-section="standings">Standings</li>
                    <li class="sidebar-link" data-section="rosters">Rosters</li>
                    <li class="sidebar-link" data-section="schedule">Schedule</li>
                    <li class="sidebar-link" data-section="trades">Trades</li>
                    <li class="sidebar-link" data-section="recruiting">Recruiting</li>
                    <li class="sidebar-link" data-section="playoffs">Playoffs</li>
                    <li class="sidebar-link" data-section="scout-points">Scout Points</li>
                    <li class="sidebar-link" data-section="staff">Staff</li>
                    <li class="sidebar-link" data-section="settings">Settings</li>
                </ul>
            </nav>
        </aside>
        <main class="main-content">
            <div id="home" class="section active">
                <div class="welcome">
                    <img src="logo-new.png" alt="LEAGUEbuddy Logo" class="main-logo">
                    <h1>Welcome to LEAGUEbuddy Dashboard!</h1>
                </div>
                <div style="text-align:center;margin:32px 0;">
                    <a href="/api/auth/discord" class="discord-login-btn"
                        style="background:#5865F2;color:#fff;padding:12px 32px;border-radius:8px;font-size:1.2rem;font-weight:700;text-decoration:none;box-shadow:0 2px 8px rgba(0,0,0,0.10);display:inline-block;">Login
                        with Discord</a>
                </div>
            </div>
            <div id="league-info" class="section">
                <h2 style="color:#ffd600;">League Info</h2>
                <div class="league-info-card" id="league-info-card">
                    <p>Loading...</p>
                </div>
            </div>
            <div id="trades" class="section">
                <h2 style="color:#ffd600;">Trade Builder</h2>
                <div class="trade-builder-sleeper" style="display:flex;gap:32px;justify-content:center;">
                    <div class="trade-team-col">
                        <label for="from-team" style="color:#ffd600;font-weight:700;">Your Team</label>
                        <select id="from-team" style="margin-bottom:16px;"></select>
                        <div style="margin-bottom:8px;font-weight:600;color:#ffd600;">Players</div>
                        <div id="from-assets" class="trade-assets" style="flex-wrap:wrap;margin-bottom:16px;"></div>
                        <div style="margin-bottom:8px;font-weight:600;color:#ffd600;">Picks</div>
                        <div id="from-picks" class="trade-assets" style="flex-wrap:wrap;"></div>
                    </div>
                    <div class="trade-team-col">
                        <label for="to-team" style="color:#ffd600;font-weight:700;">Other Team</label>
                        <select id="to-team" style="margin-bottom:16px;"></select>
                        <div style="margin-bottom:8px;font-weight:600;color:#ffd600;">Players</div>
                        <div id="to-assets" class="trade-assets" style="flex-wrap:wrap;margin-bottom:16px;"></div>
                        <div style="margin-bottom:8px;font-weight:600;color:#ffd600;">Picks</div>
                        <div id="to-picks" class="trade-assets" style="flex-wrap:wrap;"></div>
                    </div>
                </div>
                <div class="trade-summary-bar"
                    style="margin-top:32px;padding:24px 0 0 0;border-top:2px solid #ffd600;text-align:center;">
                    <div id="trade-summary-details" style="font-size:1.1rem;margin-bottom:12px;"></div>
                    <div id="salary-feedback" style="margin-bottom:16px;font-weight:700;"></div>
                    <button id="submit-trade"
                        style="background:#ffd600;color:#23242a;font-weight:700;padding:12px 32px;border:none;border-radius:24px;cursor:pointer;font-size:1.1rem;">Submit
                        Trade</button>
                </div>
                <hr style="margin:32px 0;border-color:#ffd600;">

            </div>
            <div id="rosters" class="section">
                <h2 style="color:#ffd600;">Team Rosters</h2>
                <div style="margin-bottom:24px;">
                    <input id="team-search" type="text" placeholder="Search team..."
                        style="width:300px;padding:8px 16px;font-size:1.1rem;border-radius:8px;border:1px solid #ffd600;">
                    <select id="team-select"
                        style="width:220px;padding:8px 16px;font-size:1.1rem;border-radius:8px;border:1px solid #ffd600;margin-left:12px;"></select>
                </div>
                <div id="rosters-team-title" style="font-size:1.4rem;font-weight:700;color:#ffd600;margin-bottom:16px;">
                </div>
                <div id="rosters-team-cards" style="display:grid;grid-template-columns:repeat(3,1fr);gap:24px;"></div>
            </div>
        </main>
    </div>
    <script>
        // Roster UI: search bar and team select
        let allTeams = [];
        function setupRosterSearch() {
            fetch('/api/teams').then(res => res.json()).then(teams => {
                allTeams = teams;
                const select = document.getElementById('team-select');
                select.innerHTML = '';
                teams.forEach(team => {
                    const opt = document.createElement('option');
                    opt.value = team.key;
                    opt.textContent = team.name;
                    select.appendChild(opt);
                });
                select.selectedIndex = 0;
                loadTeamCards(teams[0].key, teams[0].name);
            });
            document.getElementById('team-search').addEventListener('input', function () {
                const val = this.value.toLowerCase();
                const select = document.getElementById('team-select');
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].textContent.toLowerCase().includes(val)) {
                        select.selectedIndex = i;
                        loadTeamCards(select.value, select.options[i].textContent);
                        break;
                    }
                }
            });
            document.getElementById('team-select').addEventListener('change', function () {
                const name = this.options[this.selectedIndex].textContent;
                loadTeamCards(this.value, name);
            });
        }

        // Show player cards for selected team
        function loadTeamCards(teamKey, displayName) {
            document.getElementById('rosters-team-title').textContent = displayName;
            fetch(`/api/teams/${teamKey}`).then(res => res.json()).then(data => {
                const container = document.getElementById('rosters-team-cards');
                container.innerHTML = '';
                let players = Array.isArray(data.players) ? data.players : [];
                if (!players.length) {
                    container.innerHTML = '<p>No players found.</p>';
                    return;
                }
                function calcAge(birthdate) {
                    if (!birthdate) return '';
                    const dob = new Date(birthdate);
                    const now = new Date('2025-10-25');
                    let age = now.getFullYear() - dob.getFullYear();
                    const m = now.getMonth() - dob.getMonth();
                    if (m < 0 || (m === 0 && now.getDate() < dob.getDate())) {
                        age--;
                    }
                    return age;
                }
                players.forEach((p, idx) => {
                    const card = document.createElement('div');
                    card.className = 'player-card';
                    card.style = 'background:#23242a;border-radius:12px;padding:24px;min-width:0;max-width:100%;color:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.10);position:relative;display:flex;flex-direction:column;align-items:flex-start;';
                    card.innerHTML = `
                        <div style='font-weight:700;font-size:1.1rem;margin-bottom:8px;'>${p.name}</div>
                        <div><strong>Position:</strong> ${p.position || ''}</div>
                        <div><strong>Salary:</strong> ${p.salary || ''}</div>
                        <div><strong>OVR:</strong> ${p.ovr || ''}</div>
                        <div><strong>Age:</strong> ${calcAge(p.birthdate)}</div>
                        <div><strong>Archetype:</strong> <span class='archetype-val'>${p.archetype || ''}</span></div>
                        <div><strong>Height:</strong> ${p.height || ''}</div>
                        <div><strong>Weight:</strong> ${p.weight || ''}</div>
                        <div><strong>Birthdate:</strong> ${p.birthdate || ''}</div>
                        <div><strong>Years in NBA:</strong> ${p.yearsInNBA || ''}</div>
                        <div><strong>Wingspan:</strong> ${p.wingspan || ''}</div>
                        <button class='edit-player-card-btn' data-idx='${idx}' style='position:absolute;top:12px;right:12px;background:#ffd600;color:#23242a;border:none;padding:4px 10px;border-radius:6px;cursor:pointer;'>Edit</button>
                    `;
                    // Attach edit button handler immediately after rendering
                    card.querySelector('.edit-player-card-btn').onclick = function () {
                        editPlayerCard(card, p, players, teamKey, displayName);
                    };
                    container.appendChild(card);
                });
            });
        }

        // Edit player card UI
        function editPlayerCard(card, player, players, teamKey, displayName) {
            // Only use the async archetype-fetching version
            function calcAge(birthdate) {
                if (!birthdate) return '';
                const dob = new Date(birthdate);
                const now = new Date('2025-10-25');
                let age = now.getFullYear() - dob.getFullYear();
                const m = now.getMonth() - dob.getMonth();
                if (m < 0 || (m === 0 && now.getDate() < dob.getDate())) {
                    age--;
                }
                return age;
            }
            fetch('/api/all-archetypes')
                .then(res => res.json())
                .then(archetypes => {
                    console.log('editPlayerCard called for', player.name);
                    card.innerHTML = `
                        <div style='font-weight:700;font-size:1.1rem;margin-bottom:8px;'><input value="${player.name}" id="edit-name" style="width:120px;"></div>
                        <div><strong>Position:</strong> <input value="${player.position || ''}" id="edit-position" style="width:80px;"></div>
                        <div><strong>Salary:</strong> <input value="${player.salary || ''}" id="edit-salary" style="width:100px;"></div>
                        <div><strong>OVR:</strong> <input value="${player.ovr || ''}" id="edit-ovr" style="width:50px;"></div>
                        <div><strong>Age:</strong> ${calcAge(player.birthdate)}</div>
                        <div><strong>Archetype:</strong> <select id="edit-archetype" style="width:180px;">
                            <option value="">Select archetype</option>
                            ${archetypes.map(type => `<option value='${type.replace(/'/g, '&#39;')}'${type === player.archetype ? ' selected' : ''}>${type}</option>`).join('')}
                        </select></div>
                        <div><strong>Height:</strong> ${player.height || ''}</div>
                        <div><strong>Weight:</strong> ${player.weight || ''}</div>
                        <div><strong>Birthdate:</strong> ${player.birthdate || ''}</div>
                        <div><strong>Years in NBA:</strong> ${player.yearsInNBA || ''}</div>
                        <div><strong>Wingspan:</strong> ${player.wingspan || ''}</div>
                        <button id="save-edit" style='background:#4caf50;color:#fff;border:none;padding:4px 10px;border-radius:6px;cursor:pointer;margin-top:12px;'>Save</button>
                    `;
                    document.getElementById('save-edit').onclick = function () {
                        console.log('save-edit clicked for', player.name);
                        player.name = document.getElementById('edit-name').value;
                        player.position = document.getElementById('edit-position').value;
                        player.salary = document.getElementById('edit-salary').value;
                        player.ovr = document.getElementById('edit-ovr').value;
                        player.archetype = document.getElementById('edit-archetype').value;
                        fetch(`/api/teams/${teamKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ players })
                        }).then(() => {
                            loadTeamCards(teamKey, displayName);
                        });
                    };
                });
        }
        // Helper: Get all unique archetypes from backend
        async function getAllArchetypes() {
            const res = await fetch('/api/all-archetypes');
            if (!res.ok) return [];
            return await res.json();
        }

        // Edit row logic for player field editing
        function openEditRow(row, player, data, teamKey, displayName) {
            getAllArchetypes().then(archetypes => {
                row.innerHTML = `
                    <td><input value="${player.name}" id="edit-name" style="width:100px;"></td>
                    <td><input value="${player.position || ''}" id="edit-position" style="width:80px;"></td>
                    <td><input value="${player.salary || ''}" id="edit-salary" style="width:100px;"></td>
                    <td><input value="${player.ovr || ''}" id="edit-ovr" style="width:50px;"></td>
                    <td>${player.age || ''}</td>
                    <td><select id="edit-archetype" style="width:180px;">
                        <option value="">Select archetype</option>
                        ${archetypes.map(type => `<option value='${type.replace(/'/g, '&#39;')}'${type === player.archetype ? ' selected' : ''}>${type}</option>`).join('')}
                    </select></td>
                    <td><button id="save-edit" style='background:#4caf50;color:#fff;border:none;padding:4px 10px;border-radius:6px;cursor:pointer;'>Save</button></td>
                `;
                document.getElementById('save-edit').onclick = function () {
                    player.name = document.getElementById('edit-name').value;
                    player.position = document.getElementById('edit-position').value;
                    player.salary = document.getElementById('edit-salary').value;
                    player.ovr = document.getElementById('edit-ovr').value;
                    player.archetype = document.getElementById('edit-archetype').value;
                    fetch(`/api/teams/${teamKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ players: data.players })
                    }).then(() => {
                        loadTeamRoster(teamKey, displayName);
                    });
                };
            });
        }
        // Helper: Format currency
        function formatSalary(s) {
            return '$' + Number(s).toLocaleString();
        }
        // Helper: Render player/pick cards
        function renderAssets(elementId, data, type) {
            const el = document.getElementById(elementId);
            el.innerHTML = '';
            if (type === 'players' && data.players && data.players.length) {
                data.players.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'trade-card';
                    card.dataset.name = p.name;
                    card.dataset.salary = p.salary;
                    card.style = 'background:#23242a;border-radius:12px;padding:14px 16px;min-width:160px;max-width:220px;color:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.10);margin-bottom:8px;display:flex;flex-direction:column;align-items:flex-start;gap:2px;';
                    card.innerHTML = `
                        <div style='font-weight:700;font-size:1.05rem;'>${p.name}</div>
                        <div style='color:#ffd600;font-weight:600;'>${p.position || ''}</div>
                        <div><strong>OVR:</strong> ${p.ovr || ''}</div>
                        <div><strong>Salary:</strong> ${p.salary || ''}</div>
                        <div><strong>Archetype:</strong> ${p.archetype || ''}</div>
                        <div><strong>Age:</strong> ${p.birthdate ? (() => { const dob = new Date(p.birthdate); const now = new Date('2025-10-25'); let age = now.getFullYear() - dob.getFullYear(); const m = now.getMonth() - dob.getMonth(); if (m < 0 || (m === 0 && now.getDate() < dob.getDate())) { age--; } return age; })() : ''}</div>
                        ${p.tradeBlock ? "<span class='trade-block'>TRADE BLOCK</span>" : ''}
                    `;
                    card.onclick = () => {
                        card.classList.toggle('selected');
                        updateTradeSummary();
                    };
                    el.appendChild(card);
                });
            }
            if (type === 'picks' && data.picks && data.picks.length) {
                data.picks.forEach(pick => {
                    const card = document.createElement('div');
                    card.className = 'trade-card';
                    card.dataset.pick = pick;
                    card.innerHTML = `<span>${pick}</span>`;
                    // Only allow protections for first round picks
                    if (/1st/.test(pick)) {
                        const prot = document.createElement('select');
                        prot.className = 'pick-protection-select';
                        prot.style = 'margin-left:8px;';
                        ['Unprotected', 'Top 3', 'Top 5', 'Top 10', 'Lottery'].forEach(opt => {
                            const o = document.createElement('option');
                            o.value = opt;
                            o.textContent = opt;
                            prot.appendChild(o);
                        });
                        prot.onchange = () => {
                            card.dataset.protection = prot.value;
                            updateTradeSummary();
                        };
                        card.appendChild(prot);
                    }
                    card.onclick = (e) => {
                        // Don't toggle selection if clicking dropdown
                        if (e.target.classList.contains('pick-protection-select')) return;
                        card.classList.toggle('selected');
                        updateTradeSummary();
                    };
                    el.appendChild(card);
                });
            }
        }
        // Helper: Convert team name to file name
        function teamNameToFile(teamName) {
            return teamName.toLowerCase().replace(/ /g, '_');
        }
        // Sidebar tab switching logic
        const links = document.querySelectorAll('.sidebar-link');
        const sections = document.querySelectorAll('.section');
        links.forEach(link => {
            link.addEventListener('click', () => {
                links.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                sections.forEach(section => {
                    section.classList.remove('active');
                });
                const section = document.getElementById(link.dataset.section);
                if (section) section.classList.add('active');
                // Fetch live league info when League Info tab is clicked
                if (link.dataset.section === 'league-info') {
                    fetch('/api/league-info')
                        .then(res => res.json())
                        .then(data => {
                            const card = document.getElementById('league-info-card');
                            card.innerHTML = `
                <p><strong>League Name:</strong> ${data.leagueName}</p>
                <p><strong>Season:</strong> ${data.season}</p>
                <p><strong>Staff:</strong> ${Array.isArray(data.staff) ? data.staff.join(', ') : data.staff}</p>
                <p><strong>Number of Teams:</strong> ${data.numberOfTeams}</p>
                <p><strong>Current Week:</strong> ${data.currentWeek}</p>
                <p><strong>League Rules:</strong> <span style="color:#fff;">${data.leagueRules}</span></p>
                <p><strong>Server Link:</strong> <a href="${data.serverLink}" style="color:#ffd600;">${data.serverLink}</a></p>
                <p><strong>Total Current Coaches:</strong> ${data.totalCoaches}</p>
                <p><strong>Current Available Teams:</strong> ${data.availableTeams}</p>
              `;
                        })
                        .catch(() => {
                            document.getElementById('league-info-card').innerHTML = '<p>Error loading league info.</p>';
                        });
                }
                // Fetch trades and rosters when Trades tab is clicked
                if (link.dataset.section === 'trades') {
                    setupTradeBuilderForCoach();
                    // Pending trades section removed, no trades-list to update
                }
                // Fetch and display all teams in rosters sidebar when Rosters tab is clicked
                if (link.dataset.section === 'rosters') {
                    fetch('/api/teams')
                        .then(res => res.json())
                        .then(teams => {
                            const list = document.getElementById('rosters-team-list');
                            list.innerHTML = '';
                            teams.forEach(team => {
                                const li = document.createElement('li');
                                li.textContent = team.name;
                                li.className = 'rosters-team-item';
                                li.style = 'padding:10px 0;cursor:pointer;color:#ffd600;font-weight:600;';
                                li.onclick = () => loadTeamRoster(team.key, team.name);
                                list.appendChild(li);
                            });
                            // Auto-select first team
                            if (teams.length) loadTeamRoster(teams[0].key, teams[0].name);
                        });
                }
            });
        });
        // Load rosters and picks for selected teams
        function loadRostersAndPicks() {
            const fromTeam = document.getElementById('from-team').value;
            const toTeam = document.getElementById('to-team').value;
            if (!fromTeam || !toTeam) return;
            fetch(`/api/teams/${fromTeam}`)
                .then(res => res.json())
                .then(data => {
                    renderAssets('from-assets', data, 'players');
                    renderAssets('from-picks', data, 'picks');
                    updateTradeSummary();
                });
            fetch(`/api/teams/${toTeam}`)
                .then(res => res.json())
                .then(data => {
                    renderAssets('to-assets', data, 'players');
                    renderAssets('to-picks', data, 'picks');
                    updateTradeSummary();
                });
        }
        // Listen for team changes
        document.addEventListener('change', e => {
            if (e.target.id === 'from-team' || e.target.id === 'to-team') {
                loadRostersAndPicks();
            }
        });
        // Update trade summary and salary feedback
        function updateTradeSummary() {
            // Get selected assets
            const fromPlayers = Array.from(document.querySelectorAll('#from-assets .trade-card.selected')).filter(card => card.dataset.name).map(card => card.dataset.name);
            const toPlayers = Array.from(document.querySelectorAll('#to-assets .trade-card.selected')).filter(card => card.dataset.name).map(card => card.dataset.name);
            const fromPicks = [
                ...Array.from(document.querySelectorAll('#from-assets .trade-card.selected')).filter(card => card.dataset.pick),
                ...Array.from(document.querySelectorAll('#from-picks .trade-card.selected')).filter(card => card.dataset.pick)
            ].map(card => card.dataset.pick);
            const toPicks = [
                ...Array.from(document.querySelectorAll('#to-assets .trade-card.selected')).filter(card => card.dataset.pick),
                ...Array.from(document.querySelectorAll('#to-picks .trade-card.selected')).filter(card => card.dataset.pick)
            ].map(card => card.dataset.pick);
            // Calculate salaries
            const fromSalaries = Array.from(document.querySelectorAll('#from-assets .trade-card.selected')).filter(card => card.dataset.salary).map(card => {
                // Remove $ and commas, then parse as integer
                return parseInt(card.dataset.salary.replace(/[$,]/g, '')) || 0;
            });
            const toSalaries = Array.from(document.querySelectorAll('#to-assets .trade-card.selected')).filter(card => card.dataset.salary).map(card => {
                return parseInt(card.dataset.salary.replace(/[$,]/g, '')) || 0;
            });
            const fromTotal = fromSalaries.reduce((a, b) => a + b, 0);
            const toTotal = toSalaries.reduce((a, b) => a + b, 0);
            // Update summary
            document.getElementById('trade-summary-details').innerHTML = `
        <p><strong>Your Team Sends:</strong> ${[
                    ...fromPlayers,
                    ...fromPicks.map(p => {
                        const card = [
                            ...Array.from(document.querySelectorAll('#from-assets .trade-card.selected')),
                            ...Array.from(document.querySelectorAll('#from-picks .trade-card.selected'))
                        ].find(c => c.dataset.pick === p);
                        // Only show protection for first round picks
                        if (/1st/.test(p)) {
                            let prot = card && card.dataset.protection ? card.dataset.protection : 'None';
                            return `${p} <span class=\"pick-protection\">(Protection: ${prot})</span>`;
                        } else {
                            return p;
                        }
                    })
                ].join(', ') || 'None'}</p>
        <p><strong>Other Team Sends:</strong> ${[
                    ...toPlayers,
                    ...toPicks.map(p => {
                        const card = [
                            ...Array.from(document.querySelectorAll('#to-assets .trade-card.selected')),
                            ...Array.from(document.querySelectorAll('#to-picks .trade-card.selected'))
                        ].find(c => c.dataset.pick === p);
                        if (/1st/.test(p)) {
                            let prot = card && card.dataset.protection ? card.dataset.protection : 'None';
                            return `${p} <span class=\"pick-protection\">(Protection: ${prot})</span>`;
                        } else {
                            return p;
                        }
                    })
                ].join(', ') || 'None'}</p>
        <p><strong>Your Team Total Salary:</strong> ${formatSalary(fromTotal)}</p>
        <p><strong>Other Team Total Salary:</strong> ${formatSalary(toTotal)}</p>
      `;
            // Salary matching feedback
            const diff = Math.abs(fromTotal - toTotal);
            let feedback = '';
            if (diff <= 3000000) {
                feedback = `<span style=\"color:#4caf50;\">Salaries match! Difference: ${formatSalary(diff)}</span>`;
            } else {
                feedback = `<span style=\"color:#f44336;\">Salaries do not match. Difference: ${formatSalary(diff)}</span>`;
            }
            document.getElementById('salary-feedback').innerHTML = feedback;
        }
        // Approve/reject trade functions
        function approveTrade(idx) {
            fetch(`/api/pending-trades/approve/${idx}`, { method: 'POST' })
                .then(res => res.json())
                .then(() => {
                    alert('Trade approved and rosters updated!');
                    // Refresh trades and rosters
                    document.querySelector('.sidebar-link[data-section="trades"]').click();
                });
        }
        function rejectTrade(idx) {
            fetch(`/api/pending-trades/reject/${idx}`, { method: 'POST' })
                .then(res => res.json())
                .then(() => {
                    alert('Trade rejected.');
                    document.querySelector('.sidebar-link[data-section="trades"]').click();
                });
        }
        // Submit trade logic
        document.getElementById('submit-trade').addEventListener('click', () => {
            console.log('Submit Trade button clicked');
            const fromTeam = document.getElementById('from-team').value;
            const toTeam = document.getElementById('to-team').value;
            const fromPlayers = Array.from(document.querySelectorAll('#from-assets .trade-card.selected')).filter(card => card.dataset.name).map(card => card.dataset.name);
            const toPlayers = Array.from(document.querySelectorAll('#to-assets .trade-card.selected')).filter(card => card.dataset.name).map(card => card.dataset.name);
            const fromPicks = Array.from(document.querySelectorAll('#from-assets .trade-card.selected')).filter(card => card.dataset.pick).map(card => card.dataset.pick);
            const toPicks = Array.from(document.querySelectorAll('#to-assets .trade-card.selected')).filter(card => card.dataset.pick).map(card => card.dataset.pick);
            if (!fromTeam || !toTeam || (fromPlayers.length === 0 && fromPicks.length === 0 && toPlayers.length === 0 && toPicks.length === 0)) {
                alert('Select teams and at least one player or pick to trade.');
                return;
            }
            const trade = {
                fromTeam,
                toTeam,
                players: fromPlayers,
                playersTo: toPlayers,
                picks: fromPicks,
                picksTo: toPicks,
                status: 'Pending'
            };
            fetch('/api/pending-trades', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(trade)
            })
                .then(res => res.json())
                .then(async (result) => {
                    console.log('Trade POST response:', result);
                    // Always show confirmation/loading in UI
                    const confirmationDivId = 'trade-confirmation-message';
                    let confirmationDiv = document.getElementById(confirmationDivId);
                    if (!confirmationDiv) {
                        confirmationDiv = document.createElement('div');
                        confirmationDiv.id = confirmationDivId;
                        confirmationDiv.style.marginTop = '24px';
                        confirmationDiv.style.fontWeight = '700';
                        confirmationDiv.style.color = '#ffd600';
                        confirmationDiv.style.textAlign = 'center';
                        document.querySelector('.trade-summary-bar').appendChild(confirmationDiv);
                    }
                    confirmationDiv.textContent = 'Processing trade...';
                    // Convert dropdown/team key to coachRoleMap.json format
                    function toCoachRoleMapKey(teamKey) {
                        // Replace underscores with spaces and capitalize each word
                        return teamKey.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                    }
                    let coachName = '';
                    let userFound = false;
                    let lookupKey = toCoachRoleMapKey(toTeam);
                    let roleId = null;
                    try {
                        const coachRoleMap = await fetch('/data/coachRoleMap.json').then(r => r.json());
                        roleId = coachRoleMap[lookupKey];
                        console.log('LookupKey:', lookupKey, 'RoleId:', roleId);
                        if (!roleId) {
                            confirmationDiv.textContent = `Error: No coach role found for team (${lookupKey}).`;
                            confirmationDiv.style.color = '#f44336';
                            console.warn(`No roleId found for team: ${lookupKey}`);
                        } else {
                            const userRes = await fetch(`/api/discord-user-by-role/${roleId}`);
                            if (userRes.ok) {
                                const user = await userRes.json();
                                console.log('Discord user lookup result:', user);
                                if (user.username) {
                                    coachName = ` (@${user.username})`;
                                    userFound = true;
                                    confirmationDiv.textContent = `Sent trade to ${coachName.replace(' (@', '').replace(')', '')}`;
                                    confirmationDiv.style.color = '#ffd600';
                                    console.log('Trade sent to:', coachName);
                                } else {
                                    confirmationDiv.textContent = 'Error: Could not find coach for this team.';
                                    confirmationDiv.style.color = '#f44336';
                                    console.warn(`No Discord username found for roleId: ${roleId}`);
                                }
                            } else {
                                confirmationDiv.textContent = 'Error: Could not find coach for this team.';
                                confirmationDiv.style.color = '#f44336';
                                console.warn(`Discord user lookup failed for roleId: ${roleId}`);
                            }
                        }
                    } catch (err) {
                        confirmationDiv.textContent = 'Error: Could not submit trade.';
                        confirmationDiv.style.color = '#f44336';
                        console.error('Error fetching Discord user:', err);
                    }
                    // ...pending trades section removed, no refresh needed...
                })
                .catch(() => {
                    const confirmationDivId = 'trade-confirmation-message';
                    let confirmationDiv = document.getElementById(confirmationDivId);
                    if (!confirmationDiv) {
                        confirmationDiv = document.createElement('div');
                        confirmationDiv.id = confirmationDivId;
                        confirmationDiv.style.marginTop = '24px';
                        confirmationDiv.style.fontWeight = '700';
                        confirmationDiv.style.textAlign = 'center';
                        document.querySelector('.trade-summary-bar').appendChild(confirmationDiv);
                    }
                    confirmationDiv.textContent = 'Error: Could not submit trade.';
                    confirmationDiv.style.color = '#f44336';
                    console.error('Error proposing trade.');
                });
        });
        // Only use card-based roster UI and editing
        document.querySelector('.sidebar-link[data-section="rosters"]').addEventListener('click', () => {
            setupRosterSearch();
        });
        document.addEventListener('DOMContentLoaded', () => {
            updateTradeSummary();
        });
        // Check login and roles for UI
        fetch('/api/me').then(res => res.json()).then(user => {
            window.currentUser = user;
            if (user && user.roles && user.roles.includes('YOUR_STAFF_ROLE_ID')) {
                document.body.classList.add('is-staff');
            } else {
                document.body.classList.remove('is-staff');
            }
        });
        // Example: Hide approve/reject buttons if not staff
        function updatePendingTradesUI() {
            const isStaff = document.body.classList.contains('is-staff');
            document.querySelectorAll('.approve-btn, .reject-btn').forEach(btn => {
                btn.style.display = isStaff ? '' : 'none';
            });
        }
        // Fetch and display logged-in Discord user info
        function renderUserProfileBar() {
            fetch('/api/me').then(res => {
                if (!res.ok) throw new Error('Not logged in');
                return res.json();
            }).then(user => {
                if (!user) {
                    document.getElementById('user-profile-bar').style.display = 'none';
                    return;
                }
                const bar = document.getElementById('user-profile-content');
                let avatarUrl = user.avatar
                    ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`
                    : 'https://cdn.discordapp.com/embed/avatars/0.png';
                bar.innerHTML = `
              <img src="${avatarUrl}" alt="avatar" style="width:40px;height:40px;border-radius:50%;border:2px solid #ffd600;object-fit:cover;">
              <div>
                <div style="font-weight:700;">${user.username}</div>
                <div style="font-size:0.95rem;color:#ffd600;">Logged in</div>
              </div>
              <a href="/api/auth/discord" style="margin-left:24px;color:#ffd600;font-weight:700;text-decoration:none;">Switch User</a>
            `;
            }).catch(() => {
                document.getElementById('user-profile-bar').style.display = 'none';
            });
        }
        renderUserProfileBar();
        window.renderUserProfileBar = renderUserProfileBar;
    </script>
    <script>
        function getTeamFromRole(roles) {
            // Map Discord role IDs to team keys
            const roleToTeam = {
                '1428100606622695485': 'atlanta_hawks',
                '1428100611395817604': 'boston_celtics',
                '1428100616982368367': 'brooklyn_nets',
                '1428100621931778153': 'charlotte_hornets',
                '1428100628017840128': 'chicago_bulls',
                '1428100633898127532': 'cleveland_cavaliers',
                '1428100638486822913': 'dallas_mavericks',
                '1428100644916428864': 'denver_nuggets',
                '1428100650423550074': 'detroit_pistons',
                '1428100655267971214': 'golden_state_warriors',
                '1428100664516415548': 'houston_rockets',
                '1428100669453242479': 'indiana_pacers',
                '1428100674750644345': 'los_angeles_clippers',
                '1428100680018559076': 'los_angeles_lakers',
                '1428100684892344552': 'memphis_grizzlies',
                '1428100690479284246': 'miami_heat',
                '1428100695416111165': 'milwaukee_bucks',
                '1428100700688351303': 'minnesota_timberwolves',
                '1428100705776046211': 'new_orleans_pelicans',
                '1428100710997954651': 'new_york_knicks',
                '1428100717243138061': 'oklahoma_city_thunder',
                '1428100723077419008': 'orlando_magic',
                '1428100728194470012': 'philadelphia_76ers',
                '1428100733416374475': 'phoenix_suns',
                '1428100738566979594': 'portland_trail_blazers',
                '1428100744992788651': 'sacramento_kings',
                '1428100749966966784': 'san_antonio_spurs',
                '1428100754585026767': 'toronto_raptors',
                '1428100759936831639': 'utah_jazz',
                '1428100764877848787': 'washington_wizards'
            };
            for (const role of roles) {
                if (roleToTeam[role]) return roleToTeam[role];
            }
            return null;
        }
        function setupTradeBuilderForCoach() {
            fetch('/api/me').then(res => res.json()).then(user => {
                if (!user || !user.roles) return;
                const coachTeamKey = getTeamFromRole(user.roles);
                if (!coachTeamKey) return;
                fetch('/api/teams').then(res => res.json()).then(teams => {
                    const fromSelect = document.getElementById('from-team');
                    const toSelect = document.getElementById('to-team');
                    fromSelect.innerHTML = '';
                    toSelect.innerHTML = '';
                    let coachTeamObj = null;
                    let firstOtherTeamObj = null;
                    teams.forEach(team => {
                        const opt1 = document.createElement('option');
                        opt1.value = team.key;
                        opt1.textContent = team.name;
                        if (team.key === coachTeamKey) {
                            opt1.selected = true;
                            coachTeamObj = team;
                        }
                        fromSelect.appendChild(opt1);
                    });
                    // Find first team that isn't the coach's team
                    for (const team of teams) {
                        if (team.key !== coachTeamKey && !firstOtherTeamObj) {
                            firstOtherTeamObj = team;
                        }
                        const opt2 = document.createElement('option');
                        opt2.value = team.key;
                        opt2.textContent = team.name;
                        if (firstOtherTeamObj && team.key === firstOtherTeamObj.key) {
                            opt2.selected = true;
                        }
                        toSelect.appendChild(opt2);
                    }
                    fromSelect.value = coachTeamKey;
                    fromSelect.disabled = true;
                    toSelect.disabled = false;
                    // Load correct roster for coach's team and first other team
                    if (coachTeamObj && firstOtherTeamObj) {
                        loadTeamCards(coachTeamObj.key, coachTeamObj.name);
                        loadTeamCards(firstOtherTeamObj.key, firstOtherTeamObj.name);
                        // Load assets and picks for both teams
                        loadRostersAndPicks();
                    }
                });
            });
        }
        // ...existing code...
    </script>
    <script>
        function hideDashboardTabs() {
            document.querySelectorAll('.sidebar-link').forEach(tab => {
                tab.style.display = 'none';
            });
        }
        function showDashboardTabs() {
            document.querySelectorAll('.sidebar-link').forEach(tab => {
                tab.style.display = '';
            });
        }
        function checkLoginAndShowTabs() {
            fetch('/api/me').then(res => res.json()).then(user => {
                if (user && user.id) {
                    showDashboardTabs();
                } else {
                    hideDashboardTabs();
                }
            }).catch(hideDashboardTabs);
        }
        // Hide tabs by default
        hideDashboardTabs();
        // Check login on page load
        checkLoginAndShowTabs();
    </script>
</body>

</html>